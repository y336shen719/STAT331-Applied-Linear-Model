## Yiming Shen
## 20891774

###########################################################################
## a3q3
## Check data
head(homes)
## Fit model
myfit <- lm(Price ~ PropTax + Nbeds + Nbaths + New + Size, data=homes)
summary(myfit)

## (a)
## Plot of studentized residuals VS. fitted value
plot(myfit$fitted.values, rstudent(myfit), xlab="Fitted Values", ylab="Studentized Residuals")
abline(h=c(0), lty=2, col="red")

## QQ plot
qqnorm(rstudent(myfit))
qqline(rstudent(myfit), col="red", lwd=2)

## (b)
## Box-Cox transformation
library(MASS)
bc = boxcox(myfit)
lambda = bc$x[which.max(bc$y)]
lambda
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ## Fit value with box-cox transformed response
transf_myfit <- lm((Price^lambda-1)/lambda ~ PropTax + Nbeds + Nbaths + New + Size, data=homes)
summary(transf_myfit)

## (c)
## Plot of studentized residuals VS. fitted value
plot(transf_myfit$fitted.values, rstudent(transf_myfit), xlab="Fitted Values", ylab="Studentized Residuals")
abline(h=c(0), lty=2, col="red")

## QQ plot
qqnorm(rstudent(transf_myfit))
qqline(rstudent(transf_myfit), col="red", lwd=2)

## (d)
## Perform backward elimination model selection based on p-value
summary(transf_myfit)
## Step1: remove Nbaths
adj1_myfit <- lm((Price^lambda-1)/lambda ~ PropTax + Nbeds + New + Size, data=homes)
summary(adj1_myfit)
## Step2: remove Nbeds
adj2_myfit <- lm((Price^lambda-1)/lambda ~ PropTax + New + Size, data=homes)
summary(adj2_myfit)
## No more variable can be dropped, end

###########################################################################
## a3q4
## Check data
head(hospital_dat_raw)

## (a)
## Fit the model
my_fit <- lm(Stay ~ Culture + Xray + as.factor(Region) + Census, data=hospital_dat_raw)
summary(my_fit)

## (b)
## Histogram of studentized residuals for normality
hist(rstudent(my_fit), xlim=c(-6,6))

## QQ-plot for normality
qqnorm(my_fit$residuals)
qqline(my_fit$residuals, col="red", lwd=2)

## Residual plot: vs fitted values for equal variance
plot(my_fit$fitted.values, my_fit$residuals, xlab = "Fitted Values", ylab = "Studentized Residuals")
abline(h = c(0), lty = 2, col = "red")

## Residual plot: vs predictor for linearity 
par(mfrow = c(2,2))
plot(hospital_dat_raw$Culture, my_fit$residuals, xlab="Culture", ylab="Residuals")
abline(h=c(0), lty=2, col="red")
plot(hospital_dat_raw$Xray, my_fit$residuals, xlab="Xray", ylab="Residuals")
abline(h=c(0), lty=2, col="red")
plot(hospital_dat_raw$Region, my_fit$residuals, xlab="Region", ylab="Residuals")
abline(h=c(0), lty=2, col="red")
plot(hospital_dat_raw$Census, my_fit$residuals, xlab="Census", ylab="Residuals")
abline(h=c(0), lty=2, col="red")

## (c)
## Residual plot: vs fitted values for response outliers
plot(my_fit$fitted.values, my_fit$residuals, xlab = "Fitted Values", ylab = "Studentized Residuals")
abline(h = c(-3,3), lty = 2, col = "red")
list(my_fit$residuals>3 | my_fit$residuals<(-3))

## Plot of leverage for explanatory variables outliers
plot(hatvalues(my_fit), xlab="Index i", ylab="Leverge")
n <- nrow(hospital_dat_raw)
n
p <- 4
abline(h = c(2*(p+1)/n), lty=2, col="red")
list(hatvalues(my_fit)>2*(p+1)/n)

## Plot of Cook's distance for influential observations
plot(cooks.distance(my_fit), xlab="Index i", ylab="Cook's distance")
abline(h=c(0.5), lty=2, col="red")
list(cooks.distance(my_fit)>0.5)

## (d)
## based on (c), we find that the 46th observation is a influential observation.
excluded_my_fit <- lm(Stay ~ Culture + Xray + as.factor(Region) + Census, data=hospital_dat_raw[-46,])
summary(excluded_my_fit)

###########################################################################
## Q5
## Check data
head(crime_A3)
crimedat <- crime_A3
n = nrow(crimedat) ## number of observations
library(glmnet)

## Perform K-fold cross validation
K = 10 ## create folds as K=10
set.seed(20891774)
folds = sample((1:n)%%K + 1) ## Split data into train and validation

RMSPE = c()
for (t in 0:50) {
  RMSPE_k = c()
for (k in 1:K) {
  validSet <- crimedat[folds==k,] 
  trainSet <- crimedat[folds!=k,]
  md <- glmnet(x=as.matrix(trainSet[,-1]), y=trainSet$CrimeRate, family="gaussian", alpha=1, lambda=t*0.1) ##lambda=[0,5] in 0.1 increment
  pred <- predict(md, newx = as.matrix(validSet[,-1]))
  RMSPE_k[k] <- sqrt(mean((validSet$CrimeRate - pred)^2))
}
RMSPE[t] = mean(RMSPE_k)
}
RMSPE

## Find the min(RMSPE)
x <- min(RMSPE)
x

## lambda=0.7
predictors = as.matrix(crimedat[,-1]) ## extracting the design matrix removing the response column
response = crimedat$CrimeRate
fit_lasso = glmnet(x=predictors, y=response, family="gaussian", alpha=1, lambda=0.7)
coef(fit_lasso)
## This would be the final prediction model based on lasso regression that we could use for future prediction modeling


